{% extends "base.html" %}
{% block title %}Library{% endblock %}

{% block content %}
<div class="py-8">

    <!-- Search Bar -->
    <form action="/search-books" method="GET" class="mb-8">
        <div class="flex gap-3">
            <input 
                type="text" 
                name="q"
                placeholder="Search for a book by title or author..."
                class="flex-grow px-4 py-2 rounded-lg bg-white/80 dark:bg-gray-700/60 shadow focus:outline-none"
                required
            >
            <button 
                type="submit"
                class="btn px-6 py-2 rounded-lg bg-teal-600 hover:bg-teal-700 text-white shadow">
                Search
            </button>
        </div>
    </form>

    <form action="/filter-books" method="GET"
        class="flex flex-wrap gap-4 mb-8">

        <!-- Status filter -->
        <select name="status" aria-label="Filter by status" class="px-3 py-2 rounded-lg bg-white/70 dark:bg-gray-700/70 shadow">
            <option value="">All statuses</option>
            <option value="to-read">To Read</option>
            <option value="reading">Reading</option>
            <option value="finished">Finished</option>
        </select>

        <!-- Genre filter -->
        <select name="genre" aria-label="Filter by genre" class="px-3 py-2 rounded-lg bg-white/70 dark:bg-gray-700/70 shadow">
            <option value="">All genres</option>
            {% for g in genres %}
                <option value="{{ g }}">{{ g }}</option>
            {% endfor %}
        </select>

        <!-- Author filter -->
        <select name="author" aria-label="Filter by author" class="px-3 py-2 rounded-lg bg-white/70 dark:bg-gray-700/70 shadow">
            <option value="">All authors</option>
            {% for a in authors %}
                <option value="{{ a }}">{{ a }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="px-6 py-2 rounded-lg bg-teal-600 hover:bg-teal-700 text-white shadow">
            Apply
        </button>
    </form>

    <h1 class="text-3xl font-bold mb-6">Your Library</h1>

    {% if books %}
        <div id="booksGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">

            {% for book in books %}
                <div class="relative group p-4 backdrop-blur-md bg-white/70 dark:bg-gray-800/70 
                            rounded-xl shadow-md hover:shadow-xl transition-transform duration-300 
                            transform hover:scale-[1.02] border border-white/30 dark:border-gray-700/40" data-book-id="{{ book.id }}">

                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div class="h-12 flex items-center justify-center px-2">
                            <h2 class="text-xl font-bold tracking-tight leading-tight line-clamp-2">
                                {{ book.title }}
                            </h2>
                        </div>

                        {% if book.author %}
                            <p class="text-gray-600 dark:text-gray-300 text-sm mb-1">
                                <em>{{ book.author }}</em>
                                {% if book.year %}
                                    ‚Ä¢ <span class="text-gray-500 dark:text-gray-400">{{ book.year }}</span>
                                {% endif %}
                            </p>
                        {% endif %}

                        {% if book.cover_url %}
                            <a href="/book/{{ book.id }}" class="w-36 aspect-[2/3] overflow-hidden rounded shadow mt-2 mb-2 block group-hover:shadow-lg transition cursor-pointer">
                                <img 
                                    src="{{ book.cover_url }}" 
                                    class="w-full h-full object-cover"
                                    alt="Cover of {{ book.title }}"
                                >
                            </a>                               
                        {% endif %}

                        <div class="min-h-[2.5rem] flex flex-col justify-center">
                            {% if book.genres %}
                                <p class="text-gray-700 dark:text-gray-300 text-sm mb-2 line-clamp-2">
                                    Genres: <span class="font-medium">{{ book.genres }}</span> 
                                </p>
                            {% endif %}
                        </div>                        

                        {% if book.status %}
                            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">
                                Status: <span class="font-medium">{{ book.status }}</span>
                            </p>
                        {% endif %}

                        <!-- Status Selector -->
                        <form action="/update-status/{{ book.id }}" method="POST" class="mt-2">
                            <div class="flex gap-2 text-sm justify-center flex-wrap">

                                <button type="submit" name="status" value="to-read"
                                    class="px-3 py-1 rounded-full border transition 
                                    {% if book.status == 'to-read' %}
                                        bg-teal-600 text-white border-teal-700
                                    {% else %}
                                        bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-teal-200/50 dark:hover:bg-teal-700/30
                                    {% endif %}">
                                    To Read
                                </button>

                                <button type="submit" name="status" value="reading"
                                    class="px-3 py-1 rounded-full border transition 
                                    {% if book.status == 'reading' %}
                                        bg-indigo-600 text-white border-indigo-700
                                    {% else %}
                                        bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-indigo-200/50 dark:hover:bg-indigo-700/30
                                    {% endif %}">
                                    Reading
                                </button>

                                <button type="submit" name="status" value="finished"
                                    class="px-3 py-1 rounded-full border transition 
                                    {% if book.status == 'finished' %}
                                        bg-emerald-600 text-white border-emerald-700
                                    {% else %}
                                        bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-emerald-200/50 dark:hover:bg-emerald-700/30
                                    {% endif %}">
                                    Finished
                                </button>

                            </div>
                        </form>

                        <form action="/add-to-collection/{{ book.id }}" method="POST" class="mt-2 collection-form">
                            <select name="collection_id"
                                    aria-label="Add to collection"
                                    class="px-2 py-1 rounded bg-white/70 dark:bg-gray-700/70"
                                    onchange="this.form.submit()">
                                <option value="">Add to collection...</option>
                                {% for c in collections %}
                                    <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>  <!-- closes z-10 content wrapper -->

                    <form action="/delete-book/{{ book.id }}" method="POST" class="delete-form relative z-20" data-booktitle="{{ book.title }}">
                        <button type="submit"
                            class="w-7 h-7 flex items-center justify-center rounded-full
                                shadow-md hover:scale-110 transition duration-200
                                {% if current_user.theme == 'spring' %}
                                    bg-red-500/80 text-white
                                {% elif current_user.theme == 'midnight' %}
                                    bg-red-400/60 backdrop-blur-xl text-white
                                {% elif current_user.theme == 'fireplace' %}
                                    bg-yellow-900/80 text-yellow-200
                                {% endif %}">
                            üóë
                        </button>
                    </form>
                </div>      <!-- closes clickable card wrapper -->

                                            
                {% if loop.index % 4 == 0 %}
                <div class="col-span-full flex flex-col items-center my-8">

                    <!-- Top highlight (thin soft light on the plank) -->
                    <div class="w-full h-[2px] bg-white/30 dark:bg-white/10 rounded-full mb-[2px]"></div>

                    <!-- Main plank (the shelf itself) -->
                    <div class="w-full h-[10px] bg-black/25 dark:bg-white/20 rounded-md shadow-md"></div>

                    <!-- Bottom shadow (gives depth and realism) -->
                    <div class="w-full h-[6px] bg-black/30 dark:bg-white/10 rounded-b-md 
                                shadow-[0_6px_10px_rgba(0,0,0,0.4)] mt-[2px]"></div>

                </div>
                {% endif %}
            {% endfor %}

        </div>

        {% if has_more %}
        <div class="flex justify-center mt-10">
            <a href="{{ url_for('library', page=page + 1) }}#loadedContent"
            class="px-6 py-2 rounded-full bg-black/40 dark:bg-white/25 
                    text-white dark:text-black font-semibold shadow-md
                    hover:bg-black/60 dark:hover:bg-white/40 transition">
                Load More
            </a>
        </div>
        {% endif %}
        
    {% else %}
        <p class="text-gray-700 dark:text-gray-300 text-lg">
            You haven‚Äôt added any books yet üìñ  
        </p>
        <p class="text-gray-500 dark:text-gray-400">
            Search for a book and then use the ‚ÄúAdd Book‚Äù option to start building your library.
        </p>    
    {% endif %}

</div>

<div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-xl w-80">
        <h2 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">Remove Book?</h2>
        <p id="deleteMessage" class="text-gray-600 dark:text-gray-300 mb-6"></p>

        <div class="flex justify-end gap-3">
            <button id="cancelDelete"
                class="px-4 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">
                Cancel
            </button>

            <button id="confirmDelete"
                class="px-4 py-1 rounded-lg bg-red-600 text-white hover:bg-red-700">
                Remove
            </button>
        </div>
    </div>
</div>

<script>
    if (window.location.hash === "#loadedContent") {
        window.scrollTo({
            top: document.body.scrollHeight,
            behavior: "smooth"
        });
    }
</script>

<script>
let deleteForm = null;

document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();  // stop real submit
        deleteForm = this;

        const title = this.dataset.booktitle;
        document.getElementById("deleteMessage").innerText =
            `Are you sure you want to remove "${title}" from your library?`;

        document.getElementById("deleteModal").classList.remove("hidden");
    });
});

document.getElementById("cancelDelete").onclick = () => {
    document.getElementById("deleteModal").classList.add("hidden");
};

document.getElementById("confirmDelete").onclick = () => {
    if (deleteForm) deleteForm.submit();
};
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("booksGrid");

    if (!grid) return;

    new Sortable(grid, {
        animation: 150,
        ghostClass: "opacity-40",
        onEnd: function () {
            const order = [...document.querySelectorAll("[data-book-id]")].map(
                el => el.dataset.bookId
            );

            fetch("/update-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ order })
            });
        }
    });
});
</script>

{% endblock %}