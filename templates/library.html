{% extends "base.html" %}
{% block title %}Library{% endblock %}

{% block content %}
<div class="library-frame">

    <div class="library-shelf left"></div>

    <div class="library-content">

            <!-- Search Bar -->
            <form action="/search-books" method="GET" class="mb-8 pt-2">
                <div class="flex gap-3">
                    <input 
                        type="text" 
                        name="q"
                        placeholder="Search for a book by title and/or author..."
                        class="flex-grow px-4 py-2 rounded-lg bg-white/80 shadow focus:outline-none"
                        required 
                    >
                    <button 
                        type="submit"
                        class="btn rounded-lg">
                        Search
                    </button>
                </div>
            </form>

            <form action="{{ url_for('library') }}" method="GET"
                class="flex flex-wrap gap-4 mb-8">

                <!-- Status filter -->
                <select name="status" aria-label="Filter by status" class="px-3 py-2 rounded-lg bg-white/70 shadow">
                    <option value="">All statuses</option>
                    <option value="to-read" {{ "selected" if selected_status == "to-read" else "" }}>To Read</option>
                    <option value="reading" {{ "selected" if selected_status == "reading" else "" }}>Reading</option>
                    <option value="finished" {{ "selected" if selected_status == "finished" else "" }}>Finished</option>
                </select>

                <!-- Genre filter -->
                <select name="genre" aria-label="Filter by genre" class="px-3 py-2 rounded-lg bg-white/70 shadow">
                    <option value="">All genres</option>
                    {% for g in genres %}
                        <option value="{{ g }}" {{ "selected" if selected_genre == g else "" }}>
                            {{ g }}
                        </option>
                    {% endfor %}
                </select>

                <!-- Author filter -->
                <select name="author" aria-label="Filter by author" class="px-3 py-2 rounded-lg bg-white/70 shadow">
                    <option value="">All authors</option>
                    {% for a in authors %}
                        <option value="{{ a }}" {{ "selected" if selected_author == a else "" }}>
                            {{ a }}
                        </option>
                    {% endfor %}
                </select>

                <button type="submit" class="btn rounded-lg">
                    Apply
                </button>
                <a href="{{ url_for('library') }}" class="btn rounded-lg no-underline">
                    Reset
                </a>

            </form>

            <h1 class="text-3xl font-bold mb-6">Your Library</h1>

            <div id="loadedContent">            

                {% if books %}                       
                    <div id="booksGrid" class="grid grid-flow-row grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">

                        {% for book in books %}
                            <div name="bookCard" class="relative group p-4 backdrop-blur-md bg-white/70  
                                        rounded-xl shadow-md hover:shadow-xl transition-transform duration-300 
                                        transform hover:scale-[1.02] border border-white/30" data-book-id="{{ book.id }}">

                                <div name="dragHandle" class="drag-handle absolute top-1.5 left-1.5 w-6 h-6 rounded-full bg-black/10
                                            flex items-center justify-center text-gray-700 cursor-grab hover:bg-black/20
                                            transition z-20 select-none">
                                    ‚ò∞
                                </div>

                                <div class="relative z-10 flex flex-col items-center text-center">
                                    <div class="h-12 flex items-center justify-center px-2">
                                        <h2 name="bookCardText" class="text-xl font-bold tracking-tight leading-tight line-clamp-2">
                                            {{ book.title }}
                                        </h2>
                                    </div>

                                    <div class="h-10 flex items-center justify-center px-2">
                                        {% if book.author %}
                                            <p name="bookCardText" class="text-gray-600 text-sm leading-tight line-clamp-2">
                                                <em>{{ book.author }}</em>
                                                {% if book.year %}
                                                    ‚Ä¢ <span name="bookCardText" class="text-gray-500">{{ book.year }}</span>
                                                {% endif %}
                                            </p>
                                        {% endif %}
                                    </div>

                                    {% if book.cover_url %}
                                        <a href="/book/{{ book.id }}" class="w-36 aspect-[2/3] overflow-hidden rounded shadow mt-2 mb-2 block group-hover:shadow-lg transition cursor-pointer">
                                            <img 
                                                src="{{ book.cover_url }}" 
                                                class="w-full h-full object-cover"
                                                alt="Cover of {{ book.title }}"
                                            >
                                        </a>                               
                                    {% endif %}

                                    <div class="h-12 flex items-center justify-center px-3 text-center">
                                        {% if book.genres %}
                                            <p name="bookCardText" class="text-gray-700 text-sm leading-tight line-clamp-2">
                                                Genres: <span name="bookCardText" class="font-medium">{{ book.genres }}</span>
                                            </p>
                                        {% endif %}
                                    </div>                        

                                    <div class="min-h-[1.5rem] flex items-center justify-center">
                                        {% if book.status %}
                                            <p name="bookCardText" class="text-sm text-gray-700 leading-tight">
                                                Status: <span name="bookCardText" class="font-medium">{{ book.status }}</span>
                                            </p>
                                        {% endif %}
                                    </div>

                                    <!-- Status Selector -->
                                    <form action="/update-status/{{ book.id }}" method="POST" class="mt-2">
                                        <div class="flex gap-2 text-sm justify-center flex-wrap">

                                            <button type="submit" name="status" value="to-read" class="status-to-read rounded-full border transition cursor-pointer {% if book.status == 'to-read' %}ring-2 ring-offset-2 ring-black/40{% else %}opacity-50{% endif %}">To Read</button>

                                            <button type="submit" name="status" value="reading" class="status-reading rounded-full border transition cursor-pointer {% if book.status == 'reading' %}ring-2 ring-offset-2 ring-black/40{% else %}opacity-50{% endif %}">Reading</button>

                                            <button type="submit" name="status" value="finished" class="status-finished rounded-full border transition cursor-pointer {% if book.status == 'finished' %}ring-2 ring-offset-2 ring-black/40{% else %}opacity-50{% endif %}">Finished</button>

                                        </div>
                                    </form>

                                    <form action="/add-to-collection/{{ book.id }}" method="POST" class="mt-2 collection-form">
                                        <select name="collection_id"
                                                aria-label="Add to collection"
                                                class="collection-select rounded bg-white/70"
                                                onchange="this.form.submit()">
                                            <option value="">Add to collection...</option>
                                            {% for c in collections %}
                                                <option value="{{ c.id }}">{{ c.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </form>

                                    <form action="/delete-book/{{ book.id }}" method="POST"
                                        class="delete-form relative z-20 mt-3"
                                        data-booktitle="{{ book.title }}">
                                        <button name="delete" type="submit"
                                            class="w-8 h-8 flex items-center justify-center rounded-full
                                                shadow-md hover:scale-110 transition duration-200">
                                            üóë
                                        </button>
                                    </form>
                                </div>  <!-- closes z-10 content wrapper -->
                            </div>      <!-- closes clickable card wrapper -->

                                                        
                            {% if loop.index % 4 == 0 %}
                            <div class="hidden sm:flex col-span-full flex-col items-center my-8">

                                <!-- Top highlight (thin soft light on the plank) -->
                                <div name="shelfTop" class="w-full h-[2px] bg-white/30 rounded-full mb-[2px]"></div>

                                <!-- Main plank (the shelf itself) -->
                                <div name="shelfMiddle" class="w-full h-[10px] bg-black/25 rounded-md shadow-md"></div>

                                <!-- Bottom shadow (gives depth and realism) -->
                                <div name="shelfBottom" class="w-full h-[6px] bg-black/30 rounded-b-md 
                                            shadow-[0_6px_10px_rgba(0,0,0,0.4)] mt-[2px]"></div>

                            </div>
                            {% endif %}
                        {% endfor %}

                    </div>

                    {% if has_more %}
                    <div class="flex justify-center mt-10">
                        <a id="loadMoreLink" href="{{ url_for(
                                'library',
                                page=page + 1,
                                status=selected_status,
                                genre=selected_genre,
                                author=selected_author
                            ) }}"
                        class="px-6 py-2 rounded-full bg-black/40  
                                text-white font-semibold shadow-md
                                hover:bg-black/60 transition">
                            Load More
                        </a>
                    </div>
                    {% endif %}
                    
                {% else %}
                    <p class="text-gray-700 text-lg">
                        You haven‚Äôt added any books yet üìñ  
                    </p>
                    <p class="text-gray-500">
                        Search for a book and then use the ‚ÄúAdd Book‚Äù option to start building your library.
                    </p>    
                {% endif %}
            </div>

        <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-80">
                <h2 class="text-lg font-bold mb-3 text-gray-800">Remove Book?</h2>
                <p id="deleteMessage" class="text-gray-600"></p>

                <div class="flex justify-end gap-3">
                    <button id="cancelDelete"
                        class="btn rounded-lg">
                        Cancel
                    </button>

                    <button id="confirmDelete"
                        class="btn rounded-lg">
                        Remove
                    </button>
                </div>
            </div>
        </div>

        <script>
        let deleteForm = null;

        document.querySelectorAll('.delete-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();  // stop real submit
                deleteForm = this;

                const title = this.dataset.booktitle;
                document.getElementById("deleteMessage").innerText =
                    `Are you sure you want to remove "${title}" from your library?`;

                document.getElementById("deleteModal").classList.remove("hidden");
            });
        });

        document.getElementById("cancelDelete").onclick = () => {
            document.getElementById("deleteModal").classList.add("hidden");
        };

        document.getElementById("confirmDelete").onclick = () => {
            if (deleteForm) deleteForm.submit();
        };
        </script>

        <script>
        document.addEventListener("DOMContentLoaded", () => {
            const isMobile = window.matchMedia("(max-width: 640px)").matches;
            if (isMobile) return;

            const grid = document.getElementById("booksGrid");
            if (!grid) return;

            new Sortable(grid, {
                animation: 150,
                ghostClass: "opacity-40",
                handle: ".drag-handle",
                onEnd: function () {
                    const order = [...document.querySelectorAll("[data-book-id]")].map(
                        el => el.dataset.bookId
                    );

                    fetch("/update-order", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ order })
                    });
                }
            });
        });
        </script>

        <script>
        document.addEventListener("DOMContentLoaded", () => {

            // Only animate ONCE EVER
            if (!localStorage.getItem("sway-once-ever")) {

                const cards = document.querySelectorAll("[name='bookCard']");

                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add("sway-on-load");
                        setTimeout(() => card.classList.remove("sway-on-load"), 1300);
                    }, index * 90); // gentle stagger for beautiful flow
                });

                // Never show again unless localStorage is cleared
                localStorage.setItem("sway-once-ever", "true");
            }
        });
        </script>

        <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Restore scroll after server-side "Load More"
            const saved = sessionStorage.getItem("libraryScrollY");
            if (saved !== null) {
                sessionStorage.removeItem("libraryScrollY");
                window.scrollTo({ top: parseInt(saved, 10), behavior: "instant" });
            }

            // Save scroll position right before navigating
            const link = document.getElementById("loadMoreLink");
            if (link) {
                link.addEventListener("click", () => {
                    sessionStorage.setItem("libraryScrollY", String(window.scrollY));
                });
            }
        });
        </script>
    </div>

    <div class="library-shelf right"></div>

</div>
{% endblock %}