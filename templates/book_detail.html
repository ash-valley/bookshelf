{% extends "base.html" %}
{% block title %}{{ book.title }} â€” Book Details{% endblock %}

{% block content %}
<div class="mt-12">

    <!-- Header Layout -->
    <div class="flex flex-col md:flex-row gap-10">

        <!-- Cover -->
        {% if book.cover_url %}
        <img src="{{ book.cover_url }}"
            alt="Cover of {{ book.title }}"
            class="w-48 rounded-xl shadow-lg">
        {% endif %}

        <!-- Info Section -->
        <div>
            <h1 class="text-4xl font-bold mb-2">{{ book.title }}</h1>

            {% if book.author %}
            <p class="text-lg text-gray-700 mb-1">
                By <span class="font-medium">{{ book.author }}</span>
            </p>
            {% endif %}

            <div class="mt-4 text-gray-700 space-y-1 text-sm">
                {% if book.year %}
                <p class="text-gray-600 mb-1">
                    <strong>Published:</strong> {{ book.year }}
                </p>
                {% endif %}

                {% if book.genres %}
                <p class="text-gray-600 mb-4">
                    <strong>Genres:</strong> {{ book.genres }}
                </p>
            {% endif %}                
            </div>            

            <!-- Status Selector -->
            <form action="/update-status/{{ book.id }}" method="POST" class="mt-4">
                <div class="flex gap-3 text-sm">

                    <button type="submit" name="status" value="to-read"
                        class="status-to-read rounded-full border transition cursor-pointer {% if book.status == 'to-read' %}ring-2 ring-offset-2 ring-black/40{% else %}opacity-50{% endif %}">
                        To Read
                    </button>

                    <button type="submit" name="status" value="reading"
                        class="status-reading rounded-full border transition cursor-pointer {% if book.status == 'reading' %}ring-2 ring-offset-2 ring-black/40{% else %}opacity-50{% endif %}">
                        Reading
                    </button>

                    <button type="submit" name="status" value="finished"
                        class="status-finished rounded-full border transition cursor-pointer {% if book.status == 'finished' %}ring-2 ring-offset-2 ring-black/40{% else %}opacity-50{% endif %}">
                        Finished
                    </button>

                </div>
            </form>

        </div>
    </div>

    <!-- Description -->
    {% if book.description %}
    <div class="mt-12">
        <h2 class="text-2xl font-semibold mb-4">Description</h2>
        <p class="text-gray-800 leading-relaxed text-lg">
            {{ book.description }}
        </p>
    </div>
    {% endif %}

        <!-- Collections Section -->
    <div class="mt-12">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-2xl font-semibold">Collections</h2>

            <!-- Button opens modal -->
            <button 
                class="btn rounded-lg"
                onclick="document.getElementById('collectionModal').classList.remove('hidden')">
                Add to Collection
            </button>
        </div>

        {% if book.collections %}
            <ul class="space-y-4 list-none pl-0">
                {% for col in book.collections %}
                    <li name="collectionDisplay" class="flex items-center gap-3 bg-white/60 p-3 rounded-lg shadow">
                        <a href="{{ url_for('view_collection', col_id=col.id) }}"
                        name="collection_list" class="font-medium no-underline hover:underline">
                            {{ col.name }}
                        </a>

                        <!-- Remove book from this collection -->
                        <button
                            type="button"
                            name="delete"
                            aria-label="Remove from collection"
                            class="ml-auto w-8 h-8 rounded-full transition flex-shrink-0"
                            data-delete-message="Remove this book from the collection?"
                            data-delete-url="{{ url_for('remove_from_collection', col_id=col.id, book_id=book.id) }}"
                        >
                            ðŸ—‘
                        </button>
                    </li>
                {% endfor %}
            </ul>

        {% else %}
            <p class="text-gray-600 mt-2">
                This book is not in any collections yet.
            </p>
        {% endif %}
    </div>

    <!-- Notes Section -->
    <div class="mt-12">
        <h2 class="text-2xl font-semibold mb-3">Your Notes</h2>

        <form action="{{ url_for('update_notes', book_id=book.id) }}" method="POST">

            <textarea 
                name="notes"
                rows="8"
                class="modal-input rounded bg-white/70 text-gray-900 shadow focus:outline-none resize-none"
                placeholder="Write your thoughts, impressions, quotes, or reading notes hereâ€¦"
            >{{ book.notes or "" }}</textarea>

            <button 
                type="submit"
                name="saveNotes"
                class="btn rounded-lg"
            >
                Save Notes
            </button>  

        </form>
    </div>

    <!-- Quotes Section -->
    <div class="mt-12">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-2xl font-semibold">Quotes from this Book</h2>

            <button 
                class="btn rounded-lg"
                onclick="document.getElementById('addQuoteModal').classList.remove('hidden')">
                Add Quote
            </button>
        </div>

        {% if quotes %}
            <ul class="space-y-4 list-none pl-0">
                {% for q in quotes %}
                    <li name="quotesDisplay" class="p-4 rounded-lg bg-white/70 shadow relative">

                        <p name="quotesBook" class="italic text-gray-800">"{{ q.text }}"</p>

                        {% if q.page %}
                            <p name="quotesBook" class="text-sm text-gray-600 mt-1">
                                Page: <span name="quotesBook" class="font-medium">{{ q.page }}</span>
                            </p>
                        {% endif %}

                        {% if q.tags %}
                            <p name="quotesBook" class="text-sm text-gray-600 mt-1">
                                Tags: <span name="quotesBook" class="font-medium">{{ q.tags }}</span>
                            </p>
                        {% endif %}

                        {% if q.comment %}
                            <p name="quotesBook" class="text-sm text-gray-700 mt-2">
                                ðŸ’¬ {{ q.comment }}
                            </p>
                        {% endif %}

                        <button
                            type="button"
                            aria-label="Delete quote"
                            name="delete"
                            class="absolute top-3 right-3 w-8 h-8 rounded-full transition"
                            data-delete-message="Delete this quote?"
                            data-delete-url="{{ url_for('delete_quote', quote_id=q.id) }}"
                        >
                            ðŸ—‘
                        </button>

                        <!-- Edit button -->
                        <button
                            type="button"
                            class="edit-quote-btn absolute top-3 right-12 w-8 h-8 rounded-full bg-blue-500/80 text-white flex justify-center items-center hover:scale-110 transition"
                            data-id="{{ q.id }}"
                            data-text="{{ q.text }}"
                            data-page="{{ q.page }}"
                            data-tags="{{ q.tags }}"
                            data-comment="{{ q.comment }}"
                        >
                            âœŽ
                        </button>

                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-600 mt-2">
                No quotes saved yet.
            </p>
        {% endif %}

        <form method="GET" class="flex gap-3 mb-8">

            <input 
                type="text"
                name="q"
                value="{{ quote_filter or '' }}"
                placeholder="Search within quotes..."
                class="flex-grow px-4 py-2 rounded-lg bg-white/80 shadow"
            >

            <button type="submit"
                    class="btn rounded-lg">
                Filter
            </button>

            <a href="{{ url_for('book_detail', book_id=book.id) }}" name="resetBtn"
            class="btn no-underline rounded-lg">
                Reset
            </a>

        </form>

</div>

<!-- Add to Collection Modal -->
<div id="collectionModal" 
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">

    <div class="bg-white rounded-lg p-6 shadow-xl w-80">

        <h2 name="addCollection" class="text-xl font-semibold mb-4">Add to Collection</h2>

        <form action="/add-to-collection/{{ book.id }}" method="POST">

            <select name="collection_id"
                    aria-label="Choose collection"
                    class="modal-input rounded bg-white/70 mb-4">
                <option value="">Select collection...</option>
                {% for c in collections %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>

            <div class="flex justify-end gap-3">
                <button type="button"
                        onclick="document.getElementById('collectionModal').classList.add('hidden')"
                        class="btn rounded-lg">
                    Cancel
                </button>

                <button type="submit"
                        class="btn rounded-lg">
                    Add
                </button>
            </div>

        </form>

    </div>
</div>

<!-- Add Quote Modal -->
<div id="addQuoteModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">

    <div class="bg-white rounded-lg p-6 shadow-xl w-96">

        <h2 name="addtoQuote" class="text-xl font-semibold mb-4">Add Quote</h2>

        <form action="/add-quote/{{ book.id }}" method="POST">
            <textarea id="addQuote" name="text" rows="4" required
                class="modal-input rounded bg-white/70 mb-4"
                placeholder="Quote text..."></textarea>

            <input name="page" type="text" placeholder="Page number"
                class="modal-input rounded bg-white/70 mb-4">

            <input name="tags" type="text" placeholder="Tags (comma separated)"
                class="modal-input rounded bg-white/70 mb-4">

            <textarea id="addtoQuote" name="comment" rows="3" placeholder="Your thoughts..." aria-label="Your thoughts"
                class="modal-input rounded bg-white/70 mb-4"></textarea>

            <div class="flex justify-end gap-3">
                <button type="button"
                    onclick="document.getElementById('addQuoteModal').classList.add('hidden')"
                    class="btn rounded-lg">
                    Cancel
                </button>

                <button type="submit"
                    class="btn rounded-lg">
                    Add
                </button>
            </div>
        </form>

    </div>
</div>

<!-- Edit Quote Modal -->
<div id="editQuoteModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">

    <div class="bg-white rounded-lg p-6 shadow-xl w-96">

        <h2 name="addtoQuote" class="text-xl font-semibold mb-4">Edit Quote</h2>

        <form id="editQuoteForm" method="POST">

            <textarea id="edit_text" name="text" rows="4" required placeholder="Quote text..." aria-label="Quote text"
                class="modal-input rounded bg-white/70 mb-4"></textarea>

            <input id="edit_page" name="page" type="text" placeholder="Page number"
                class="modal-input rounded bg-white/70 mb-4">

            <input id="edit_tags" name="tags" type="text" placeholder="Tags (comma separated)"
                class="modal-input rounded bg-white/70 mb-4">

            <textarea id="edit_comment" name="comment" rows="3" placeholder="Your thoughts..." aria-label="Your thoughts"
                class="modal-input rounded bg-white/70 mb-4"></textarea>

            <div class="flex justify-end gap-3">
                <button type="button"
                    onclick="document.getElementById('editQuoteModal').classList.add('hidden')"
                    class="btn rounded-lg">
                    Cancel
                </button>

                <button type="submit"
                    class="btn rounded-lg">
                    Save
                </button>
            </div>

        </form>

    </div>
</div>

<script>
function openEditQuoteModal(id, text, page, tags, comment) {
    const modal = document.getElementById("editQuoteModal");
    const form = document.getElementById("editQuoteForm");

    form.action = `/edit-quote/${id}`;

    document.getElementById("edit_text").value = text;
    document.getElementById("edit_page").value = page;
    document.getElementById("edit_tags").value = tags;
    document.getElementById("edit_comment").value = comment;

    modal.classList.remove("hidden");
    modal.classList.add("flex");
}
</script>

<script>
// Bind Edit Quote buttons
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".edit-quote-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            openEditQuoteModal(
                btn.dataset.id,
                btn.dataset.text || "",
                btn.dataset.page || "",
                btn.dataset.tags || "",
                btn.dataset.comment || ""
            );
        });
    });
});
</script>
{% endblock %}