{% extends "base.html" %}
{% block title %}{{ collection.name }} â€” Collection{% endblock %}

{% block content %}
<div class="library-frame">
    <div class="library-shelf left"></div>
    <div class="py-10 library-content">

        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold">{{ collection.name }}</h1>

            <form action="{{ url_for('remove_from_collection', col_id=collection.id, book_id=0) }}"
                method="POST" onsubmit="return false;">
                <!-- Placeholder â€“ we remove books per-card -->
            </form>
        </div>

        {% if entries %}
            <div id="collectionGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                {% for entry in entries %}
                    {% set book = entry.book %}
                    <div name="bookCard" class="relative group p-4 pt-7 pb-3 backdrop-blur-md bg-white/70  
                                rounded-xl shadow-md hover:shadow-xl transition" data-book-id="{{ book.id }}">

                        <div name="dragHandle" class="drag-handle absolute top-1.5 left-1.5 w-6 h-6 rounded-full bg-black/10
                                    flex items-center justify-center text-gray-700 cursor-grab hover:bg-black/20
                                    transition z-20 select-none">
                            â˜°
                        </div>

                        <!-- Cover -->
                        <a href="{{ url_for('book_detail', book_id=book.id) }}" name="collectionBookCover"
                        class="w-36 aspect-[2/3] overflow-hidden rounded shadow mx-auto block cursor-pointer">
                            <img src="{{ book.cover_url }}" class="w-full h-full object-cover" alt="Cover of {{ book.title }}">
                        </a>

                        <!-- Title -->
                        <h2 name="quotesBook" class="mt-3 text-lg font-bold text-center line-clamp-2">{{ book.title }}</h2>

                        <!-- Remove from collection -->
                        <button
                            type="button"
                            aria-label="Remove from collection"
                            name="delete"
                            class="absolute top-1 right-1 w-7 h-7 flex items-center justify-center
                                rounded-full bg-red-500/80 text-white shadow hover:scale-110 transition z-20"
                            data-delete-message="Remove this book from the collection?"
                            data-delete-url="{{ url_for('remove_from_collection', col_id=collection.id, book_id=book.id) }}"
                    >
                            ðŸ—‘
                        </button>

                    </div>

                    {% if loop.index % 4 == 0 %}
                    <div class="hidden sm:flex col-span-full flex-col items-center my-8">

                        <!-- Top highlight (thin soft light on the plank) -->
                        <div name="shelfTop" class="w-full h-[2px] bg-white/30 rounded-full mb-[2px]"></div>

                        <!-- Main plank (the shelf itself) -->
                        <div name="shelfMiddle" class="w-full h-[10px] bg-black/25 rounded-md shadow-md"></div>

                        <!-- Bottom shadow (gives depth and realism) -->
                        <div name="shelfBottom" class="w-full h-[6px] bg-black/30 rounded-b-md 
                                    shadow-[0_6px_10px_rgba(0,0,0,0.4)] mt-[2px]"></div>

                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600 text-lg">
                This collection is empty.
            </p>
        {% endif %}

    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const isMobile = window.matchMedia("(max-width: 640px)").matches;
        if (isMobile) return;

        const grid = document.getElementById("collectionGrid");
        if (!grid) return;

        new Sortable(grid, {
            animation: 150,
            ghostClass: "opacity-40",
            handle: ".drag-handle",
            onEnd: function () {
                const order = [...document.querySelectorAll("[data-book-id]")].map(
                    el => parseInt(el.dataset.bookId, 10)
                );

                fetch("{{ url_for('update_collection_order', col_id=collection.id) }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ order })
                });
            }
        });
    });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", () => {

        // Only animate ONCE EVER
        if (!localStorage.getItem("sway-once-ever")) {

            const cards = document.querySelectorAll("[name='bookCard']");

            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add("sway-on-load");
                    setTimeout(() => card.classList.remove("sway-on-load"), 1300);
                }, index * 90); // gentle stagger for beautiful flow
            });

            // Never show again unless localStorage is cleared
            localStorage.setItem("sway-once-ever", "true");
        }
    });
    </script>
    
    
    <div class="library-shelf right"></div>
</div>

{% endblock %}